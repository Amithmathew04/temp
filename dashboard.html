<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone Telemetry Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connected { background-color: #4CAF50; }
        .disconnected { background-color: #f44336; }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }
        select, button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .disconnect-btn {
            background-color: #dc3545;
        }
        .disconnect-btn:hover {
            background-color: #c82333;
        }
        .refresh-btn {
            background-color: #17a2b8;
        }
        .refresh-btn:hover {
            background-color: #138496;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Drone Telemetry Dashboard</h1>
        
        <!-- Connection Status -->
        <div class="card">
            <h2>Connection Status</h2>
            <div>
                <span class="status-indicator" id="serverStatus"></span>
                <span>Server: </span><span id="serverStatusText">Disconnected</span>
            </div>
            <div style="margin-top: 10px;">
                <span class="status-indicator" id="droneStatus"></span>
                <span>Drone: </span><span id="droneStatusText">Disconnected</span>
            </div>
        </div>

        <!-- Connection Controls -->
        <div class="card">
            <h2>Connection Controls</h2>
            <div class="controls">
                <select id="portSelect">
                    <option value="">Select a port</option>
                </select>
                <button id="refreshBtn" class="refresh-btn">Refresh Ports</button>
                <button id="connectBtn">Connect</button>
                <button id="disconnectBtn" class="disconnect-btn" style="display: none;">Disconnect</button>
            </div>
        </div>

        <!-- Telemetry Data -->
        <div class="card">
            <h2>Telemetry Data</h2>
            <div id="lastUpdate" style="margin-bottom: 20px; color: #666; font-size: 14px;">
                Last Update: No data received
            </div>
            <div class="data-grid" id="telemetryGrid">
                <!-- Data will be populated here -->
            </div>
        </div>
    </div>

    <script>
        let socket;
        let connected = false;
        let availablePorts = [];

        // DOM elements
        const serverStatus = document.getElementById('serverStatus');
        const serverStatusText = document.getElementById('serverStatusText');
        const droneStatus = document.getElementById('droneStatus');
        const droneStatusText = document.getElementById('droneStatusText');
        const portSelect = document.getElementById('portSelect');
        const refreshBtn = document.getElementById('refreshBtn');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const lastUpdate = document.getElementById('lastUpdate');
        const telemetryGrid = document.getElementById('telemetryGrid');

        // Initialize WebSocket connection
        function initializeSocket() {
            socket = io('http://localhost:5001');

            socket.on('connect', () => {
                console.log('Connected to server');
                updateServerStatus(true);
                fetchAvailablePorts();
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from server');
                updateServerStatus(false);
                updateDroneStatus(false);
            });

            socket.on('telemetry_data', (data) => {
                updateTelemetryData(data);
                updateDroneStatus(data.connected);
            });
        }

        // Update server connection status
        function updateServerStatus(isConnected) {
            serverStatus.className = 'status-indicator ' + (isConnected ? 'connected' : 'disconnected');
            serverStatusText.textContent = isConnected ? 'Connected' : 'Disconnected';
            refreshBtn.disabled = !isConnected;
        }

        // Update drone connection status
        function updateDroneStatus(isConnected) {
            connected = isConnected;
            droneStatus.className = 'status-indicator ' + (isConnected ? 'connected' : 'disconnected');
            droneStatusText.textContent = isConnected ? 'Connected' : 'Disconnected';
            
            connectBtn.style.display = isConnected ? 'none' : 'inline-block';
            disconnectBtn.style.display = isConnected ? 'inline-block' : 'none';
            portSelect.disabled = isConnected;
        }

        // Fetch available serial ports
        async function fetchAvailablePorts() {
            try {
                const response = await fetch('http://localhost:5001/api/ports');
                const data = await response.json();
                if (data.success) {
                    availablePorts = data.ports;
                    updatePortSelect();
                }
            } catch (error) {
                console.error('Error fetching ports:', error);
            }
        }

        // Update port selection dropdown
        function updatePortSelect() {
            portSelect.innerHTML = '<option value="">Select a port</option>';
            availablePorts.forEach(port => {
                const option = document.createElement('option');
                option.value = port.device;
                option.textContent = `${port.device} - ${port.description}`;
                portSelect.appendChild(option);
            });
        }

        // Connect to selected port
        async function connectToPort() {
            const selectedPort = portSelect.value;
            if (!selectedPort) return;

            try {
                const response = await fetch('http://localhost:5001/api/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ port: selectedPort }),
                });

                const data = await response.json();
                if (data.success) {
                    console.log('Connected to drone');
                } else {
                    console.error('Failed to connect:', data.error);
                    alert('Failed to connect: ' + data.error);
                }
            } catch (error) {
                console.error('Connection error:', error);
                alert('Connection error: ' + error.message);
            }
        }

        // Disconnect from current port
        async function disconnectFromPort() {
            try {
                const response = await fetch('http://localhost:5001/api/disconnect', {
                    method: 'POST',
                });

                const data = await response.json();
                if (data.success) {
                    console.log('Disconnected from drone');
                    updateDroneStatus(false);
                    telemetryGrid.innerHTML = '<p>No data available</p>';
                }
            } catch (error) {
                console.error('Disconnect error:', error);
            }
        }

        // Update telemetry data display
        function updateTelemetryData(data) {
            if (data.timestamp) {
                lastUpdate.textContent = `Last Update: ${data.timestamp}`;
            }

            const sections = [
                {
                    title: 'Attitude',
                    data: {
                        'Roll': formatValue(data.attitude?.roll, '°'),
                        'Pitch': formatValue(data.attitude?.pitch, '°'),
                        'Yaw': formatValue(data.attitude?.yaw, '°')
                    }
                },
                {
                    title: 'Angular Rates',
                    data: {
                        'Roll Rate': formatValue(data.angular_rates?.omega_x, '°/s'),
                        'Pitch Rate': formatValue(data.angular_rates?.omega_y, '°/s'),
                        'Yaw Rate': formatValue(data.angular_rates?.omega_z, '°/s')
                    }
                },
                {
                    title: 'Position (Local NED)',
                    data: {
                        'X': formatValue(data.position?.x, ' m'),
                        'Y': formatValue(data.position?.y, ' m'),
                        'Z': formatValue(data.position?.z, ' m')
                    }
                },
                {
                    title: 'Velocity',
                    data: {
                        'Vx': formatValue(data.velocity?.vx, ' m/s'),
                        'Vy': formatValue(data.velocity?.vy, ' m/s'),
                        'Vz': formatValue(data.velocity?.vz, ' m/s')
                    }
                },
                {
                    title: 'System Status',
                    data: {
                        'Altitude': formatValue(data.altitude, ' m'),
                        'Heading': formatValue(data.heading, '°'),
                        'Battery Voltage': formatValue(data.battery_voltage, ' V')
                    }
                }
            ];

            telemetryGrid.innerHTML = '';
            sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'card';
                sectionDiv.innerHTML = `
                    <h3>${section.title}</h3>
                    ${Object.entries(section.data).map(([key, value]) => 
                        `<div class="data-item">
                            <span>${key}:</span>
                            <span>${value}</span>
                        </div>`
                    ).join('')}
                `;
                telemetryGrid.appendChild(sectionDiv);
            });
        }

        // Format values with units
        function formatValue(value, unit = '') {
            if (value === null || value === undefined) return 'N/A';
            return `${value}${unit}`;
        }

        // Event listeners
        refreshBtn.addEventListener('click', fetchAvailablePorts);
        connectBtn.addEventListener('click', connectToPort);
        disconnectBtn.addEventListener('click', disconnectFromPort);

        // Initialize the application
        initializeSocket();
    </script>
</body>
</html>
